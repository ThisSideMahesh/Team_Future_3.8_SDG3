rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --------------------------------
    // Helper Functions
    // --------------------------------

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // Securely fetches the user's role and data from the /users collection.
    // This function can cause recursion if used improperly within /users rules.
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    // Checks if the currently authenticated user has a specific role.
    function isRole(role) {
      // This check is safe because it doesn't perform another 'get' on the users collection.
      // It assumes the role is fetched securely elsewhere or is not used in recursive rules.
      return isSignedIn() && getUserData().role == role;
    }
    
    // Checks if the user belongs to the specified institution.
    function belongsToInstitution(institutionId) {
      return isSignedIn() && getUserData().institution_id == institutionId;
    }
    
    // Checks if a patient has a valid and granted consent record.
    function hasConsent(patientId) {
      let consentDoc = get(/databases/$(database)/documents/consents/$(patientId));
      return consentDoc.data.granted == true;
    }
    
    // Checks if a temp patient record exists and is currently active.
    function isActiveTempPatient(tempId) {
      return get(/databases/$(database)/documents/temp_patients/$(tempId)).data.status == 'ACTIVE';
    }
    
    // --------------------------------
    // Collection Rules
    // --------------------------------

    // Institutions can be read by any authenticated user, but only managed by Platform Admins.
    match /institutions/{institutionId} {
      allow read: if isSignedIn();
      allow write: if isRole('platform_admin');
    }

    // Users can read/update their own profile.
    // Admins have broader access, defined in a separate rule to prevent recursion.
    match /users/{userId} {
      // 1. A user can always read/update their own profile. This rule is non-recursive.
      allow get, update: if isOwner(userId);

      // 2. Admins can access user documents based on their roles. This rule uses getUserData.
      allow get: if isRole('platform_admin') || 
                   (isRole('institution_admin') && belongsToInstitution(get(/databases/$(database)/documents/users/$(userId)).data.institution_id));
      
      // Allow user creation for any signed-in user during signup.
      allow create: if isSignedIn();
      
      // Admin update/delete permissions.
      allow update: if isRole('platform_admin') || 
                      (isRole('institution_admin') && belongsToInstitution(request.resource.data.institution_id));
      allow delete: if isRole('platform_admin') || 
                      (isRole('institution_admin') && belongsToInstitution(resource.data.institution_id));
      
      // List permission for admins.
      allow list: if isRole('platform_admin') || isRole('institution_admin');
    }

    // Patient identity documents can be read by the patient or any healthcare provider.
    // They can only be created/modified by backend processes (simulated by Platform Admin).
    match /patients/{patientId} {
      allow get: if (isRole('patient') && isOwner(patientId)) || isRole('healthcare_provider');
      allow list: if isRole('healthcare_provider');
      allow write: if isRole('platform_admin');
    }

    // Patients have full control over their own consent records.
    // Healthcare providers can read consent to verify access.
    // The doc ID must match the patient's ID for secure lookup.
    match /consents/{consentId} {
      allow read: if (isRole('patient') && request.auth.uid == resource.data.patient_id) || isRole('healthcare_provider');
      allow write: if isRole('patient') && request.auth.uid == request.resource.data.patient_id && consentId == request.auth.uid;
      allow list: if isRole('patient') && request.query.where[0][2] == request.auth.uid;
    }
    
    // Health records are the most protected data.
    // Patients can read their own. Providers can read only with consent.
    // Writes are forbidden from the client to ensure data integrity.
    match /records/{recordId} {
       allow get: if (isRole('patient') && isOwner(resource.data.patient_id)) || 
                     (isRole('healthcare_provider') && hasConsent(resource.data.patient_id));
       allow list, write, create, update, delete: if false; 
    }

    // Emergency logs are append-only for providers.
    // They are readable by the involved parties and admins for auditing.
    match /emergency_access_logs/{logId} {
      allow create: if isRole('healthcare_provider') && belongsToInstitution(request.resource.data.institution_id);
      allow get: if (isRole('patient') && isOwner(resource.data.patient_id)) ||
                   (isRole('healthcare_provider') && isOwner(resource.data.healthcare_provider_id)) ||
                   (isRole('institution_admin') && belongsToInstitution(resource.data.institution_id)) ||
                   isRole('platform_admin');
      allow list, update, delete: if false;
    }

    // API credentials can only be managed by Platform Admins.
    match /api_credentials/{credentialId} {
      allow read, write: if isRole('platform_admin');
    }
    
    // Internal meta collection for tracking seeding status. Should not be client-accessible.
    match /internal_meta/{docId} {
        allow read, write: if false;
    }

    // --------------------------------
    // Temporary Patient Rules
    // --------------------------------

    // Temp patient metadata documents.
    // Healthcare providers can create them in an emergency.
    // Admins can read metadata for auditing, but cannot update them.
    match /temp_patients/{tempId} {
        allow create: if isRole('healthcare_provider') && belongsToInstitution(request.resource.data.institution_id);
        allow get: if (isRole('healthcare_provider') && belongsToInstitution(resource.data.institution_id)) ||
                      (isRole('institution_admin') && belongsToInstitution(resource.data.institution_id)) ||
                      isRole('platform_admin');
        allow list: if isRole('institution_admin') || isRole('platform_admin');
        allow update, delete: if false;
    }
    
    // Temp patient clinical records.
    // Can be created/updated by providers from the same institution ONLY while the temporary patient record is 'ACTIVE'.
    match /temp_records/{tempId} {
        allow create: if isRole('healthcare_provider') && belongsToInstitution(request.resource.data.institution_id);
        allow get, update: if isRole('healthcare_provider') && 
                               belongsToInstitution(resource.data.institution_id) &&
                               isActiveTempPatient(tempId);
        allow list, delete: if false;
    }
  }
}
