rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --------------------------------
    // Helper Functions
    // --------------------------------

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function getUserData(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data;
    }

    function isRole(role) {
      return isSignedIn() && getUserData(request.auth.uid).role == role;
    }

    function belongsToInstitution(institutionId) {
      return isSignedIn() && getUserData(request.auth.uid).institution_id == institutionId;
    }
    
    function hasConsent(patientId) {
      // This is a placeholder for a more complex consent check.
      // In a real system, you'd query a /consents collection.
      // For this demo, we assume consent is granted if the patient document exists.
      return exists(/databases/$(database)/documents/patients/$(patientId));
    }
    
    // --------------------------------
    // Collection Rules
    // --------------------------------

    // Platform Admins have full control over institutions.
    // All other authenticated users can read the list of institutions.
    match /institutions/{institutionId} {
      allow read: if isSignedIn();
      allow write: if isRole('platform_admin');
    }

    // Users can read and update their own profile.
    // Institution Admins can manage users within their own institution.
    // Platform Admins can manage any user.
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow create: if isSignedIn(); // Allow any authenticated user to create their user record on signup.
      allow update: if isOwner(userId) 
                      || (isRole('institution_admin') && belongsToInstitution(resource.data.institution_id))
                      || isRole('platform_admin');
      allow delete: if isRole('platform_admin') 
                      || (isRole('institution_admin') && belongsToInstitution(resource.data.institution_id));
    }

    // Patients can read their own identity document.
    // Healthcare providers can read any patient's identity for lookup purposes.
    match /patients/{patientId} {
      allow get: if (isRole('patient') && isOwner(patientId))
                   || isRole('healthcare_provider');
      allow list: if isRole('healthcare_provider'); // Allow providers to list patients for search.
      allow write: if isRole('platform_admin'); // Only admins can seed patient data.
    }

    // Patients can manage their own consent.
    // Healthcare providers can read consent documents to verify access.
    match /consents/{consentId} {
      allow get: if (isRole('patient') && request.auth.uid == resource.data.patient_id)
                   || isRole('healthcare_provider');
      allow list: if isRole('patient') && request.auth.uid == request.query.patient_id;
      allow write: if isRole('patient') && request.auth.uid == request.resource.data.patient_id;
    }
    
    // Patients can read their own records.
    // Healthcare providers can read records if they have consent.
    match /records/{recordId} {
       allow get: if (isRole('patient') && isOwner(resource.data.patient_id))
                    || (isRole('healthcare_provider') && hasConsent(resource.data.patient_id));
       allow list: if false; // Unified records should not be listable directly.
       allow write: if isRole('platform_admin'); // Only backend/admin can create unified records.
    }

    // Healthcare providers can create emergency access logs for their institution.
    // The patient and the provider involved can read the log.
    match /emergency_access_logs/{logId} {
      allow create: if isRole('healthcare_provider') && belongsToInstitution(request.resource.data.institution_id);
      allow get: if (isRole('patient') && isOwner(resource.data.patient_id))
                   || (isRole('healthcare_provider') && isOwner(resource.data.healthcare_provider_id));
      allow list, update, delete: if false; // Logs are immutable.
    }

    // Platform Admins have full control over API credentials.
    match /api_credentials/{credentialId} {
      allow read, write: if isRole('platform_admin');
    }
    
    // Internal meta collection for tracking seeding status. Should not be client-accessible.
    match /internal_meta/{docId} {
        allow read, write: if false;
    }
  }
}
