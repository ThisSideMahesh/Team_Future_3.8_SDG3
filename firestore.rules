rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --------------------------------
    // Helper Functions
    // --------------------------------

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // Securely fetches the user's role and data from the /users collection.
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    // Checks if the currently authenticated user has a specific role.
    function isRole(role) {
      return isSignedIn() && getUserData().role == role;
    }
    
    // Checks if the user belongs to the specified institution.
    function belongsToInstitution(institutionId) {
      return isSignedIn() && getUserData().institution_id == institutionId;
    }
    
    // Checks if a patient has a valid and granted consent record.
    // CRITICAL: This function assumes the consent document's ID is the same as the patient's ID.
    // e.g., the consent document for patient 'PAT_001' must be at path '/consents/PAT_001'.
    function hasConsent(patientId) {
      let consentDoc = get(/databases/$(database)/documents/consents/$(patientId));
      return consentDoc.data.granted == true;
    }
    
    // --------------------------------
    // Collection Rules
    // --------------------------------

    // Institutions can be read by any authenticated user, but only managed by Platform Admins.
    match /institutions/{institutionId} {
      allow read: if isSignedIn();
      allow write: if isRole('platform_admin');
    }

    // Users can read/update their own profile.
    // Institution Admins can manage users in their own institution.
    // Platform Admins can manage any user.
    match /users/{userId} {
      allow get: if isOwner(userId) || isRole('platform_admin') || 
                   (isRole('institution_admin') && belongsToInstitution(get(/databases/$(database)/documents/users/$(userId)).data.institution_id));
      allow create: if isSignedIn();
      allow update: if isOwner(userId) || isRole('platform_admin') || 
                      (isRole('institution_admin') && belongsToInstitution(request.resource.data.institution_id));
      allow delete: if isRole('platform_admin') || 
                      (isRole('institution_admin') && belongsToInstitution(resource.data.institution_id));
      allow list: if isRole('platform_admin') || isRole('institution_admin');
    }

    // Patient identity documents can be read by the patient or any healthcare provider.
    // They can only be created/modified by backend processes (simulated by Platform Admin).
    match /patients/{patientId} {
      allow get: if (isRole('patient') && isOwner(patientId)) || isRole('healthcare_provider');
      allow list: if isRole('healthcare_provider');
      allow write: if isRole('platform_admin');
    }

    // Patients have full control over their own consent records.
    // Healthcare providers can read consent to verify access.
    // Write rule enforces that the document ID must match the patient ID for secure lookup.
    match /consents/{consentId} {
      allow read: if (isRole('patient') && request.auth.uid == resource.data.patient_id) || isRole('healthcare_provider');
      allow write: if isRole('patient') && request.auth.uid == request.resource.data.patient_id && consentId == request.auth.uid;
      allow list: if isRole('patient') && request.query.where[0][2] == request.auth.uid;
    }
    
    // Health records are the most protected data.
    // Patients can read their own. Providers can read only with consent.
    // Writes are forbidden from the client to ensure data integrity.
    match /records/{recordId} {
       allow get: if (isRole('patient') && isOwner(resource.data.patient_id)) || 
                     (isRole('healthcare_provider') && hasConsent(resource.data.patient_id));
       allow list, write, create, update, delete: if false; 
    }

    // Emergency logs are append-only for providers.
    // They are readable by the involved parties and admins for auditing.
    match /emergency_access_logs/{logId} {
      allow create: if isRole('healthcare_provider') && belongsToInstitution(request.resource.data.institution_id);
      allow get: if (isRole('patient') && isOwner(resource.data.patient_id)) ||
                   (isRole('healthcare_provider') && isOwner(resource.data.healthcare_provider_id)) ||
                   (isRole('institution_admin') && belongsToInstitution(resource.data.institution_id)) ||
                   isRole('platform_admin');
      allow list, update, delete: if false;
    }

    // API credentials can only be managed by Platform Admins.
    match /api_credentials/{credentialId} {
      allow read, write: if isRole('platform_admin');
    }
    
    // Internal meta collection for tracking seeding status. Should not be client-accessible.
    match /internal_meta/{docId} {
        allow read, write: if false;
    }
  }
}
